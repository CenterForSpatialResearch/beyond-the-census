extends layout
block content
    // initial HTML
    #drawing-container
      #overlay-target
      #map-target
    #html-container
      //#title
      //  h1 Languages of Queens
      //  input(id="show-about-content" type="button" value="about")
      //  #about-content.hidden
      //    p This map shows the incredible diversity of languages spoken in Queens, NY, based on a dataset from the Endangered Language Alliance.
      //    input(id="hide-about-content" type="button" value="hide")
      #lang-content.card.upper-left
      #list-container
        div.continent-item.filter
          div.continent-item-label
            h1 Languages of Queens
          div.filter-inputs
            p Grouping:
            //input(id="filter-string" type='text')
            select(name="select-sortby" id="select-sortby")
              option by Continent
            p Endangerment:
            #slider-range
            #slider-range-labels
        #text-target.list-block

      #underlay-controls
        h2 Map Underlay
        p Select data set to show on the map of Queens here:
        select(id="underlay-dropdown")
          option( value="nonenglish") Percent Speaking Languages other than English        
          option( value="medincome") Median Income
      #loading 
        p loading...
    
    // script starts here
    script(type='text/javascript').
        // data containers (searchoptions is for fuzzy text search...)
        var input = {
            'filterstring': '',
            'filtertype': 'langname',
            'endangermentRange': [0,10],
            'string': '',
            'underlay': 'Spanish or Spanish Creole'
          }, searchOptions = {
              extract: function(el) { return el.language; }
          }, data = {
            main: [],
            languages: [],
            countries: [],
            neighborhoods: [],
            selected: {}
          }, 
          path, 
          transform;
  
        var map = new L.Map('map-target', {zoomSnap: 0.25, zoomControl: false, attributionControl: false}).setView([40.67, -73.78], 11.5);
        Tangram.leafletLayer({ scene: '../scene.yaml' }).addTo(map);
        L.svg({ padding: 0 }).addTo(map);
        
        //map.fitBounds( [] ) use fitBounds to scale map to fit window  
        
        var overlaySVG = d3.select('#overlay-target').append('svg').attr('id', 'overlay-svg-main')
          .attr('width', window.innerWidth)
          .attr('height', window.innerHeight)        
          
        main();
        
        function main() {
          updateData( input.filtertype, input.filterstring, input.endangermentRange, () => {
            updateList();
            updateMap();
          });
        }
        d3.select('#loading')
          .classed('hidden', true);
        
        // event listeners
        d3.select('#filter-string')
          .on('input', function () {
            input.string = d3.select(this).property('value');
            console.log(input.string);
          });
          
        d3.select('#filter-endangerment')
          .on('input', function() {
            input.endangerment = d3.select(this).property('value'); // update endangerment value
            main(); // call main function, (fetch data and rerender)
          })
          
        $('#slider-range').slider({
            change: function(event, ui) {
              input.endangermentRange = ui.values
              //$('#slider-range-labels').
              main();
              //console.log(` min is ${min} and max is ${max}`)
            } 
        })
        
        d3.select('#underlay-dropdown')
          .on('input', function() {
            input.underlay = d3.select(this).property('value');
            console.log(input.underlay);
            update();
          })
          
        d3.select('#show-about-content')
          .on('click', function() {
            d3.select('#about-content')
              .classed('hidden', false);
            d3.select('#show-about-content')
              .classed('hidden', true);            
          })
          
        d3.select('#hide-about-content')
          .on('click', function() {
            d3.select('#about-content')
              .classed('hidden', true);
            d3.select('#show-about-content')
              .classed('hidden', false);            
          })          
